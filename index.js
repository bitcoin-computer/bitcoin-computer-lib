"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var n=t(require("socket.io-client"));var e=t(require("bitcoinsource"));var r=t(require("axios"));var o=t(require("eventemitter3"));function s(t,n,e,r,o,s,i){try{var c=t[s](i);var u=c.value}catch(t){return void e(t)}c.done?n(u):Promise.resolve(u).then(r,o)}function i(t){return function(){var n=this,e=arguments;return new Promise((function(r,o){var i=t.apply(n,e);function c(t){s(i,r,o,c,u,"next",t)}function u(t){s(i,r,o,c,u,"throw",t)}c(void 0)}))}}function c(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function u(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};var r=Object.keys(e);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(e).filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})))),r.forEach((function(n){c(t,n,e[n])}))}return t}function a(t,n){if(null==t)return{};var e={};var r=Object.keys(t);var o,s;for(s=0;s<r.length;s++)o=r[s],n.indexOf(o)>=0||(e[o]=t[o]);return e}function d(t,n){if(null==t)return{};var e=a(t,n);var r,o;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(o=0;o<s.length;o++)r=s[o],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(e[r]=t[r])}return e}function p(t,n){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}function l(t){var n=p(t,"string");return"symbol"==typeof n?n:String(n)}const h="mainnet";const f=546;const m=2e3;const _=2e4;const g=479;const v="https://bch.blockdozer.com/api";const y="http://bitcoinbroadcastserver-env.r5t6c3b2kj.us-west-1.elasticbeanstalk.com";const w="ws://bitcoinbroadcastserver-env.r5t6c3b2kj.us-west-1.elasticbeanstalk.com:8020";var O={BITCOIN_NETWORK:h,BLOCK_EXPLORER_URL:v,MIN_SATOSHI_AMOUNT:f,MIN_NON_DUST_AMOUNT:m,SCRIPT_CHUNK_SIZE:g,UN_P2SH_URL:y,DEFAULT_FEE:_,WS_URL:w};e.versionGuard=()=>!0,e.Networks.defaultNetwork=e.Networks[O.BITCOIN_NETWORK];class b extends Error{constructor(t,n){for(var e=arguments.length,r=new Array(e>2?e-2:0),o=2;o<e;o++)r[o-2]=arguments[o];super(...r),this.name="Error",this.message=t+(n?": ".concat(n):""),Error.captureStackTrace&&Error.captureStackTrace(this,b)}}function S(t){return{writable:!0,value:t}}function I(t,n,e){let{[t]:r}=e;return u({[n]:r},d(e,[t].map(l)))}const x=function(){var t=i((function*(t){try{return(yield t).data}catch(t){if(t.response){const{status:n,statusText:e,data:r}=t.response;const{method:o,url:s}=t.response.config||{method:"unknown",url:"unknown"};const i=t.response.config.data;const c=r.error||(-1!==r.indexOf("Code:")?r:e);throw new b("\nCommunication Error\n\nstatus\t".concat(n," ").concat(e,"\nmessage\t").concat(c,"\nrequest\t").concat(o," ").concat(s).concat(i?"\ndata\t".concat(i):""))}throw new b("Communication error","Service unavailable.")}}));return function(n){return t.apply(this,arguments)}}();const P=function(){var t=i((function*(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:O.BLOCK_EXPLORER_URL;return x(r.get("".concat(n).concat(t)))}));return function(n){return t.apply(this,arguments)}}();const N=function(){var t=i((function*(t,n){let e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:O.BLOCK_EXPLORER_URL;return x(r.post("".concat(e).concat(t),n))}));return function(n,e){return t.apply(this,arguments)}}();const k=function(){var t=i((function*(t){return P("/addr/".concat(t.toString()))}));return function(n){return t.apply(this,arguments)}}();const E=function(){var t=i((function*(t){const{balanceSat:n,unconfirmedBalanceSat:e}=yield k(t);return n+e}));return function(n){return t.apply(this,arguments)}}();const D=function(){var t=i((function*(t){return I("txid","txId",yield N("/tx/send",{rawtx:t.toString()}))}));return function(n){return t.apply(this,arguments)}}();const T=t=>t.filter((t,n,e)=>e.findIndex(n=>n.txId===t.txId&&n.vout===t.vout)===n);const K=function(){var t=i((function*(t){return P("/tx/".concat(t))}));return function(n){return t.apply(this,arguments)}}();const R=function(){var t=i((function*(t){return(yield P("/rawtx/".concat(t))).rawtx}));return function(n){return t.apply(this,arguments)}}();const j=function(){var t=i((function*(t){const n=t.toString();const e=(yield P("/addr/".concat(n,"/utxo"))).map(t=>{let{txid:n}=t,e=d(t,["txid"]);return Object.assign(e,{txId:n})});return T(e).map(t=>(t.spent=!1,t))}));return function(n){return t.apply(this,arguments)}}();const U=function(){var t=i((function*(t){const n=t.map(t=>t.__txId);const e=[...new Set(n)];const r=new Map;return yield Promise.all(e.map(function(){var t=i((function*(t){return r.set(t,yield K(t))}));return function(n){return t.apply(this,arguments)}}())),t.map(t=>{const{vout:n,blockheight:e,confirmations:o}=r.get(t.__txId)||{};return t.__vouts.map(r=>{const{scriptPubKey:s,value:i,spentTxId:c}=n[r];return{address:s.addresses[0],txId:t.__txId,vout:r,scriptPubKey:s.hex,amount:parseFloat(i),satoshis:parseInt(1e8*i,10),height:e,confirmations:o,spent:!!c}})})}));return function(n){return t.apply(this,arguments)}}();const A=function(){var t=i((function*(t){return N("/",t,O.UN_P2SH_URL)}));return function(n){return t.apply(this,arguments)}}();const J=function(){var t=i((function*(t){return P("/un-p2sh/".concat(t),O.UN_P2SH_URL)}));return function(n){return t.apply(this,arguments)}}();const M=function(){var t=i((function*(t){return P("/txos/".concat(t.toString()),O.UN_P2SH_URL)}));return function(n){return t.apply(this,arguments)}}();const C=function(){var t=i((function*(t){return N("/txos/set-spent/",t,O.UN_P2SH_URL)}));return function(n){return t.apply(this,arguments)}}();class H{constructor(t){this.kind=t}toJSON(){return{}}static fromOutputId(t){return i((function*(){const{txId:n,virtualIndex:e}=t;return(yield J(n))[e]}))()}}const{PublicKey:L,Transaction:B,Script:F}=e;class z extends H{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super("script"),Object.assign(this,t),this._amount=t._amount||O.MIN_NON_DUST_AMOUNT}getData(t){return this[t]}getSerializeData(){const t=d(this,["kind","_owners","_amount"]);return Buffer.from(JSON.stringify(t))}static fromMultiSigScriptHashInput(t){const{_scriptBuffer:n}=t;const e=et.fromBuffer(n);const{redeemScript:r=et.redeemScriptFromP2shScript(e)}=t;return this.fromRedeemScript(r)}static fromRedeemScript(t){return this.fromRedeemScripts([t])}static fromRedeemScripts(t){const n=t.map(t=>t.chunks[t.chunks.length-2].buf);const e=Buffer.concat(n);const r=JSON.parse(e.toString());return Object.assign(new this,u({kind:"script",_owners:t[0].getPublicKeys(),_amount:O.MIN_NON_DUST_AMOUNT},r))}static addVouts(t){let n=0;return t.map(t=>{const e="script"===t.kind?et.outScriptFromData(t).length:1;return t.__vouts=Array(e).fill(n).map((t,n)=>t+n),n+=e,t})}toJSON(){return u({},this,{kind:"script",_owners:(this._owners||[]).map(t=>t.toString()),_amount:O.MIN_NON_DUST_AMOUNT})}static isJSON(t){return"script"===t.kind}static fromJSON(t){const n=u({},t);return n._owners=(n._owners||[]).map(t=>new L(t)),new z(n)}}const{PublicKey:W,Address:q,Transaction:V}=e;class Z extends H{constructor(t,n){super("pkh"),this.address=t,this.amount=n}static fromPublicKeyHashInput(t){const{output:n}=t;return new this(n.script.toAddress(),n.satoshis)}toJSON(){return{kind:"pkh",address:this.address.toString(),amount:this.amount}}static isJSON(t){return t.address&&t.amount}static fromJSON(t){return new this(new q(t.address),t.amount)}}class G extends H{constructor(t){super("return"),this.data=t||""}getData(){return this.data}toJSON(){return{kind:"return",data:this.data}}static isJSON(t){return!!t.data}static fromJSON(t){return new this(t.data)}}const{Address:X,PublicKey:Q,Signature:Y,Script:$,Opcode:tt}=e;function nt(t,n){const e=[];let r=0;for(;r<t.length;)e.push(t.slice(r,r+n)),r+=n;return e}class et extends ${static outScriptFromData(t){let{kind:n,_owners:e=[],_amount:r,__vouts:o,__txId:s}=t,i=d(t,["kind","_owners","_amount","__vouts","__txId"]);const c=nt(Buffer.from(JSON.stringify(i)),O.SCRIPT_CHUNK_SIZE);return c[c.length-1].byteLength>=O.SCRIPT_CHUNK_SIZE&&nt(c.pop(),O.SCRIPT_CHUNK_SIZE).forEach(t=>{c.push(t)}),c.map(t=>{const n=new et;return n.add("OP_1"),e.forEach(t=>n.add(t.toBuffer())),n.add("OP_".concat(e.length)),n.add("OP_CHECKMULTISIG"),n.add(t),n.add("OP_DROP"),{redeemScript:n,chunk:t}})}getPublicKeys(){let t=1;const n=[];for(;this.chunks[t].buf;)n.push(new Q(this.chunks[t].buf)),t+=1;return n}static inScriptFromData(t,n,e,r){const o=new et;return e.forEach(t=>{o.add(t)}),o.add(o),o}isDbDataScript(){return!(!(this.chunks.length>=5&&this.chunks[0].opcodenum===tt.OP_1&&this.chunks[1].buf)||20!==this.chunks[1].buf.length&&33!==this.chunks[1].buf.length||this.chunks[2].opcodenum!==tt.OP_1||this.chunks[3].opcodenum!==tt.OP_CHECKMULTISIG||!this.chunks[4].buf||this.chunks[5].opcodenum!==tt.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==tt.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");const n=new $(t.chunks[2].buf);const e=new this;return e.chunks=n.chunks,e}static fromScript(t){const n=new $(t);const e=new et;return e.chunks=n.chunks,e}}const{PublicKey:rt,Address:ot}=e;class st extends H{constructor(t){super("change"),this.address=t}toJSON(){return{kind:"change",address:this.address.toString()}}static isJSON(t){return t.address}static fromJSON(t){return new this(new ot(t.address))}}const it=t=>"object"==typeof t?Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1]:Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1].toLowerCase();const ct=t=>["undefined","number","string","boolean","Null"].includes(it(t));const ut=t=>ct(t)||["Array","Object"].includes(it(t));const at=t=>t===parseInt(t,10).toString();const dt=(t,n)=>{if(!ut(t)||!ut(n))throw new Error("Unsupported data types for deep equals: ".concat(it(t)," & ").concat(it(n)));return it(t)===it(n)&&(ct(t)&&ct(n)?t===n:t&&n&&Object.entries(t).every(t=>{let[e,r]=t;return dt(n[e],r)})&&Object.entries(n).every(n=>{let[e,r]=n;return dt(t[e],r)}))};const pt=t=>{if(ct(t))return t;if("Array"===it(t))return t.map(t=>pt(t));if("Object"===it(t)){const n=Object.keys(t).reduce((n,e)=>(n[e]=pt(t[e]),n),{});const e=Object.create(Object.getPrototypeOf(t));return Object.assign(e,n)}throw new Error("Unsupported data type for clone: ".concat(it(t)))};const lt=function t(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const o=e;r[e]={};for(const s of Object.keys(n))s.startsWith("_")?r[o][s]=n[s]:ct(n[s])?r[o][s]="_":(e+=1,r[o][s]=e,({res:r,pos:e}=t(n[s],e,r)));return{res:r,pos:e}};const ht=function t(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const r=n[e];if(void 0===r)return"_";const o=Object.keys(r).every(at);const s=o?[]:{};for(const e of Object.keys(r))e.startsWith("_")?s[e]=r[e]:s[e]=t(n,r[e]);return s};class ft{static fromJSON(t){if(z.isJSON(t))return z.fromJSON(t);if(Z.isJSON(t))return Z.fromJSON(t);if(st.isJSON(t))return st.fromJSON(t);if(G.isJSON(t))return G.fromJSON(t);throw new Error("unrecognized json ".concat(JSON.stringify(t)))}}const{Mnemonic:mt,HDPrivateKey:_t,PrivateKey:gt,PublicKey:vt,Address:yt,OutputData:wt}=e;class Ot{constructor(t){this.mnemonic=t||new mt,this.path="",this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.path,O.BITCOIN_NETWORK)}static getRandomMnemonic(){return(new mt).toString()}static fromMnemonic(t){return new Ot(t)}getMnemonic(){return this.mnemonic}getPath(){return this.path}derive(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const e=new Ot(this.mnemonic);return e.path="".concat(this.path).concat(this.path.length?"/":"").concat(t).concat(n?"'":""),e.hdPrivateKey=this.hdPrivateKey.derive(t,n),e}static getHdPrivateKey(){return new _t}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(O.BITCOIN_NETWORK),this.address}getBalance(){var t=this;return i((function*(){const n=t.getAddress();return E(n.toString())}))()}getUtxos(t){var n=this,e=arguments;return i((function*(){let r=e.length>1&&void 0!==e[1]?e[1]:n.getAddress();const o=yield j(r);for(let t=o.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));const e=o[t];o[t]=o[n],o[n]=e}let s=0;const i=[];let c=0;for(;s<t&&c<o.length;)i.push(o[c]),s+=o[c].satoshis,c+=1;if(s<t)throw new Error("Insufficient balance in address ".concat(r.toString()));return i}))()}sendTransaction(t){var n=arguments;return i((function*(){let e=n.length>1&&void 0!==n[1]&&n[1];const{txId:r}=yield D(t);if(e){const n=JSON.stringify(t.outputData.map(t=>t.toJSON()));const e=t.toJSON().inputs.map(t=>{let{prevTxId:n,outputIndex:e}=t;return{txId:n,outputIndex:e}});yield A({txId:r,outputData:n,inputs:e})}return{txId:r}}))()}send(t,n,e){var r=this;return i((function*(){const o="string"==typeof n?n:n.toString();"string"==typeof e&&yt.fromString(e);const s=ft.fromJSON({amount:t,address:o});return r.sendOutputData([s],e)}))()}sendOutputData(t,n){var e=this;return i((function*(){const r=new Ut;const o=n||e.getAddress();const s=O.DEFAULT_FEE;const i=e.getPrivateKey();const c=t.reduce((t,n)=>t+parseInt(n.amount||0,10),0);return(yield e.getUtxos(c+s)).forEach(r.from.bind(r)),t.forEach(r.to.bind(r)),r.change(o),r.sign(i),e.sendTransaction(r)}))()}sendAll(t){var n=this;return i((function*(){const e=yield n.getBalance();const r=O.DEFAULT_FEE;if(e>r){const o=new Z(t,e-r);return n.sendOutputData([o])}throw new Error("Insufficient funds to send payment.")}))()}}class bt{constructor(t){this.wallet=t||new Ot}static fromMnemonic(t){return new this(new Ot(t))}put(t){var n=this;return i((function*(){return n.update([],t)}))()}get(t){return i((function*(){return bt.get(t)}))()}static getOutputDataMap(t){return i((function*(){const n=[...new Set(t)];const e=yield Promise.all(n.map(function(){var t=i((function*(t){const n=(yield J(t)).map(ft.fromJSON);let e=0;const r=n.map(n=>{const r="script"===n.kind?et.outScriptFromData(n).length:1;const o=Array(r).fill(e).map((t,n)=>t+n);return e+=r,u({},n,{__vouts:o,__txId:t})});return[t,r]}));return function(n){return t.apply(this,arguments)}}()));return new Map(e)}))()}static get(t){var n=this;return i((function*(){const e=t.map(t=>t.txId);const r=yield n.getOutputDataMap(e);return t.map(t=>{let{txId:n,virtualIndex:e}=t;const o=r.get(n);if(!o||!Array.isArray(o))throw new Error("No data found.");return o[e]})}))()}update(t,n){var e=this;return i((function*(){const r=new Ut;const o=yield e.get(t);const s=yield U(o);t.forEach(function(){var t=i((function*(t,n){r.fromScriptOutput(s[n],o[n])}));return function(n,e){return t.apply(this,arguments)}}());const c=n.map(r.to.bind(r));const u=(r._estimateSize()+20)*(O.DEFAULT_FEE/1e3);(yield e.wallet.getUtxos(u)).forEach(r.from.bind(r)),r.fee(u),r.change(e.wallet.getAddress()),r.sign(e.wallet.getPrivateKey());const{txId:a}=yield e.wallet.sendTransaction(r,!0);return t.forEach(function(){var t=i((function*(t){yield C(t)}));return function(n){return t.apply(this,arguments)}}()),c.map(t=>({txId:a,virtualIndex:t}))}))()}}const{Transaction:St,PublicKey:It,Address:xt,BN:Pt,Script:Nt,encoding:kt}=e;const{Output:Et,Input:Dt}=St;const{MultiSigScriptHash:Tt,PublicKeyHashInput:Kt}=Dt;const{BufferReader:Rt}=kt;const jt=t=>new Promise(n=>setTimeout(n,t));class Ut extends St{constructor(t){super(t),this._outputData=[],Object.defineProperty(this,"to",S(this._to)),Object.defineProperty(this,"from",S(this._from))}get dataInputs(){const t=[];const n=function*(t){for(const n of t)yield n}(this.inputs);let e=n.next();for(;!e.done;){const r=e.value;if("MultiSigScriptHashInput"===r.constructor.name)t.push(z.fromMultiSigScriptHashInput(r));else if("PublicKeyHashInput"===r.constructor.name)t.push(Z.fromPublicKeyHashInput(r));else{if("Input"!==r.constructor.name)throw new Error("unknown script class ".concat(r.constructor.name));{const e=et.fromScript(r._scriptBuffer);if(e.isPublicKeyHashIn())t.push(new Z(e.toAddress(),0));else if(et.isP2shScript(e)){let r=!1;const o=[et.redeemScriptFromP2shScript(e)];for(;!r;)try{t.push(z.fromRedeemScripts(o)),r=!0}catch(t){const e=n.next();if(e.done)throw new Error("Could not compute data inputs");const r=e.value;const s=et.fromScript(r._scriptBuffer);o.push(et.redeemScriptFromP2shScript(s))}}}}e=n.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromScriptOutput")}get inputsWithData(){return this.dataInputs.filter(t=>"script"===t.kind)}getVirtualInputs(){var t=this;return i((function*(){const{inputsWithData:n}=t;const e=z.addVouts(n);return Promise.all(e.map(function(){var n=i((function*(n){const e=[];if(n.__vouts.forEach(n=>{e.push(t.inputs[n])}),!e.every(t=>t.prevTxId.toString("hex")===e[0].prevTxId.toString("hex")))throw new Error("Something went wrong 1");const r=e[0].prevTxId.toString("hex");const o=yield Ut.fromTxId(r);yield o.fetchOutputData();const s=z.addVouts(o.outputData);const i=[];if(s.forEach((t,n)=>{dt(t.__vouts,e.map(t=>t.outputIndex))&&i.push(n)}),i.length>1)throw new Error("Something went wrong 2");return{txId:r,virtualIndex:i[0]}}));return function(t){return n.apply(this,arguments)}}()))}))()}fromMultiSig(t,n,e){const r=t.map(t=>I("txId","txid",t));return super.from(r,n,e)}_from(t){const n=I("txId","txid",t);return super.from(n)}fromScriptOutput(t,n){const e=et.outScriptFromData(n);const{_owners:r}=n;return e.forEach((n,e)=>{let{redeemScript:o}=n;const{scriptPubKey:s,satoshis:i,txId:c,vout:u}=t[e];const a=new Et({script:new et(s),satoshis:parseInt(i,10)});const d=new et;const p=new Tt({prevTxId:c,output:a,outputIndex:u,script:d},r,1,null,o);this.addInput(p)}),this}get outputData(){if(!this._outputData.length)throw new Error("dataTransaction.outputData is not initialized. Call dataTransaction.fetchDataOuptuts() first.");return this._outputData}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}get outputsWithData(){return this.outputData.filter(t=>"script"===t.kind)}change(t){const n=this.outputs.length;return super.change(t),this.outputs.length>n&&this._outputData.push(new st(t)),this}toChangeOutput(t){const n=this.outputs.length;return super.change(t.address),this.outputs.length>n&&this._outputData.push(t),this._outputData.length-1}toPkhOutput(t){return super.to(t.address,t.amount),this._outputData.push(t),this._outputData.length-1}toScriptOutput(t){const n=et.outScriptFromData(t);return this._outputData.push(t),n.forEach(n=>{let{redeemScript:e,chunk:r}=n;const o=et.buildScriptHashOut(e);const s=t._amount;const i=new Et({script:o,satoshis:s});this.addOutput(i)}),this._outputData.length-1}toReturnOutput(t){return this.addData(t.data),this._outputData.push(t),this._outputData.length-1}_to(t){switch(t.kind){case"change":return this.toChangeOutput(t);case"return":return this.toReturnOutput(t);case"script":return this.toScriptOutput(t);case"pkh":return this.toPkhOutput(t);default:throw new Error("Unsupported output kind ".concat(t.kind))}}fetchOutputData(){var t=this;return i((function*(){if(t._outputData.length)return t._outputData;const n=t.getTxId();const e=yield J(n);return t._outputData=e.map(ft.fromJSON),t._outputData}))()}get prevObjectIds(){return this.inputs.map(t=>({txId:t.prevTxId.toString("hex"),virtualIndex:t.outputIndex}))}getTxId(){return new Rt(this._getHash()).readReverse().toString("hex")}static fromTxId(t){return i((function*(){let n=null;try{n=yield R(t)}catch(e){yield jt(3e3),n=yield R(t)}const e=new Ut;return yield e.fromString(n),e}))()}}class At{eval(t){return i((function*(){return eval(t)}))()}apply(t,n,e){return i((function*(){return{res:t[n](...e),obj:t}}))()}}class Jt{constructor(){return new At}eval(t){var n=this;return i((function*(){return n.sandbox.eval(t)}))()}apply(t,n,e){var r=this;return i((function*(){return r.sandbox.apply(t,n,e)}))()}}const Mt=t=>new Promise(n=>setTimeout(n,t));class Ct{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{id:n,target:e={},db:r=new bt,sandbox:s=new Jt,eventEmitter:i=new o,socket:c}=t;this._id=n,this._rev=n,this.__target=e,this.db=r,this.sandbox=s,this.eventEmitter=i,this.socket=c,this.socket.on("message",this.onWebsocketMessage.bind(this)),this._initialized=!1,this.poll()}poll(){var t=this;return i((function*(){for(;!t._initialized;)try{yield K(t._id.txId),t._initialized=!0}catch(t){yield Mt(500)}t.eventEmitter.emit("initialized")}))()}onWebsocketMessage(t){var n=this;return i((function*(){let{data:e}=t;try{const{txId:t}=JSON.parse(e)||{};const r=yield Ut.fromTxId(t);yield r.fetchOutputData();const{__func:o,_args:s}=r.outputData[0];const c=yield r.getVirtualInputs();const u=c.findIndex(t=>dt(t,n._rev));if("constructor"===o||-1===u)return;const a=yield Promise.all(c.map(function(){var t=i((function*(t){return dt(t,n._rev)?n.__target:Ct.getObjectAt(t,n.sandbox)}));return function(n){return t.apply(this,arguments)}}()));let d=0;const[p,...l]=a;const h=s.map(t=>"__"===t?l[d++]:t);yield n.sandbox.apply(p,o,h),n._rev={txId:t,virtualIndex:u},n.eventEmitter.emit("updated")}catch(t){throw console.log("Error on websocket message",t),t}}))()}static getObjectAt(t,n){return i((function*(){const e=yield Ut.fromTxId(t.txId);yield e.fetchOutputData();const r=yield e.getVirtualInputs();const o=yield Promise.all(r.map(function(){var t=i((function*(t){return Ct.getObjectAt(t,n)}));return function(n){return t.apply(this,arguments)}}()));const{__func:s,_args:c,__cls:u}=e.outputData[0];let a=null;let d=0;if("constructor"===s){const t=o;const e=c.map(n=>"__"===n?t[d++]:n);a=[new(yield n.eval("(".concat(u,")")))(...e),...e]}else{const[t,...e]=o;const r=c.map(t=>"__"===t?e[d++]:t);yield n.apply(t,s,r),a=[t,...r]}return a[t.virtualIndex]}))()}get(t,n){var e=this;if("_id"===n||"_rev"===n||"_initialized"===n)return Reflect.get(this,n);if("_owners"===n||"_amount"===n)return Reflect.get(this.__target,n);if("__target"===n)return this.__target;if("_on"===n||"_once"===n)return(t,e)=>this.eventEmitter[n.substring(1)](t,e);if("_close"===n)throw new Error("Smart objects do not need to be closed anymore.");if("string"==typeof n&&n.startsWith("_"))throw new Error("Access to property ".concat(n," denied"));return t&&n&&"function"!=typeof t[n]?Reflect.get(t,n):Object.prototype.hasOwnProperty.call(t.constructor.prototype,n)?i((function*(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];const s=yield global.computer.update(e,n,r);yield e.db.update(global.computer.oldRevs,global.computer.newOutputs),global.computer.reset();const{eventEmitter:i}=e;return new Promise(t=>{i.once("updated",()=>{t(s)})})})):Reflect.get(t,n)}set(t,n,e){if("_rev"===n)return this._rev=e,!0;throw new Error("Cannot set property of smart object")}}class Ht{constructor(t){this.publicKey=t,this.newOutputs=[],this.oldRevs=[]}static encode(t,n){const{res:e}=lt([t,...n]);const r=e.shift();const o=Object.values(r);return e[0]._partition=o,e}static decode(t){const n=t[0]._partition;delete t[0]._partition;const e={};let r=0;for(const t of n)e[r]=t,r+=1;t.unshift(e);const o=ht(t);return{target:o.shift(),params:o}}new(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const e=n.filter(t=>t._rev);const r=n.map(t=>t._rev?"__":t);const o=n.map(t=>t._rev?t.__target:t);const s=e.map(t=>t._rev);const i=new t(...o);i._owners=i._owners||[this.publicKey.toString()],i._amount=i._amount||O.MIN_NON_DUST_AMOUNT;const c=Ht.encode(i,e);c[0].__cls=t.toString(),c[0].__func="constructor",c[0]._args=r;const u=c.map(z.fromJSON.bind(this));return this.oldRevs=[...s],this.newOutputs=u,i}update(t,n,e){var r=this;return i((function*(){const{__target:o,_rev:s,sandbox:i}=t;const c=e.filter(t=>t._rev);const u=e.map(t=>t._rev?"__":t);const a=e.map(t=>t._rev?t.__target:t);const d=c.map(t=>t._rev);const p=pt(o);const{res:l,obj:h}=yield i.apply(p,n,a);const f=Ht.encode(p,c);f[0].__func=n,f[0]._args=u,f[0]._owners=h._owners||p.owners,f[0]._amount=h._amount||p._amount;const m=f.map(z.fromJSON.bind(r));return r.oldRevs=[s,...d],r.newOutputs=m,l}))()}reset(){this.oldRevs=[],this.newOutputs=[]}}const{Mnemonic:Lt,PublicKey:Bt}=e;const Ft=function(){var t=i((function*(t,n){return new Promise(e=>{t._initialized||t._once(n,e)})}));return function(n,e){return t.apply(this,arguments)}}();class zt{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{seed:e,mnemonic:r=new Lt(e),db:o=bt.fromMnemonic(r),sandbox:s=new Jt}=t;this.db=o,this.sandbox=s,this.socket=n.connect(O.UN_P2SH_URL),global.computer=new Ht(this.db.wallet.getPublicKey())}_createSmartObject(t,n){const{db:e,socket:r}=this;const o=new Ct({id:n,target:t,db:e,socket:r});return new Proxy(t,o)}new(t){var n=this,e=arguments;return i((function*(){let r=e.length>1&&void 0!==e[1]?e[1]:[];const o=global.computer.new(t,r);const s=yield n.db.update(global.computer.oldRevs,global.computer.newOutputs);global.computer.reset(),r.filter(t=>t._rev).forEach((t,n)=>{t._rev=s[n+1]});const i=n._createSmartObject(o,s[0]);return yield Ft(i,"initialized"),i}))()}sync(t){var n=this;return i((function*(){const e=yield Ct.getObjectAt(t,n.sandbox);return n._createSmartObject(e,t)}))()}shutdown(){this.socket.disconnect(!0)}close(){throw new Error("computer.close() has been renamed to computer.shutdown()")}static getOlder(t){return i((function*(){const{txId:n,virtualIndex:e}=t[0];const r=yield Ut.fromTxId(n);return yield r.fetchOutputData(),"constructor"!==r.outputData[e].__func&&[{txId:r.inputs[0].prevTxId.toString("hex"),virtualIndex:r.inputs[0].outputIndex}]}))()}static getOldest(t){var n=this;return i((function*(){const e=yield n.getOlder(t);return e?n.getOldest(e):t}))()}getOwnedRevs(){var t=this;return i((function*(){return zt.getOwnedRevs(t.db.wallet.getPublicKey())}))()}static getOwnedRevs(t){return i((function*(){return M(t)}))()}}module.exports=zt;
